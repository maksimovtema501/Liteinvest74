<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LITE-INVEST CHELYABINSK</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<!-- Tailwind -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<style>
  :root{ --bg1:#0f172a; --bg2:#0b1220; --muted:#9fb0c8; --accent:#ff5864; }
  body{ background: linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 100%); color:#e6eef8; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .card { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015)); border: 1px solid rgba(255,255,255,0.04); box-shadow: 0 8px 30px rgba(2,6,23,0.6); }
  .accent{ color: var(--accent); } .muted{ color: var(--muted); }
  .table-header { background: linear-gradient(90deg,#071230, #091b2f); }
  .small-muted{ color: var(--muted); font-size:0.9rem; }
  .input-dark{ background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); color:#e6eef8; }
  .btn-soft{ background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.03); color:#e6eef8; }
  .highlight-row { background: linear-gradient(90deg, rgba(245,58,92,0.06), rgba(245,58,92,0.02)); border-left: 4px solid rgba(245,38,41,0.9); }
  .positive { color:#bbf7d0; background: rgba(34,197,94,0.06); }
  .negative { color:#fecaca; background: rgba(239,68,68,0.06); }
  .tab{ cursor:pointer; }
  .tab-active{ background: var(--accent); color:#fff; }
  .hidden{ display:none; }
  .color-dot{ width:14px; height:14px; border-radius:50%; display:inline-block; vertical-align:middle; margin-right:8px; border:1px solid rgba(255,255,255,0.08); }
  @media (max-width:900px){ .grid-cols-3{ grid-template-columns: 1fr; } }
</style>
</head>
<body class="antialiased">
  <div class="max-w-7xl mx-auto p-6">
    <header class="mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold accent">LITE-INVEST CHELYABINSK</h1>
        <div class="small-muted">Firebase версия — данные общие для всех</div>
      </div>
      <div id="userBox" class="text-right small-muted"></div>
    </header>

    <!-- ENTRY: Login/Register -->
    <div id="entryPanel" class="grid grid-cols-2 gap-6">
      <div class="card p-5 rounded-lg">
        <h3 class="text-lg font-semibold mb-2">Вход / Регистрация</h3>
        <div id="loginError" class="text-sm text-red-300 mb-2 hidden"></div>
        <input id="loginUsername" class="w-full p-2 rounded input-dark mb-2" placeholder="Логин (только буквы/цифры)" />
        <input id="loginPassword" type="password" class="w-full p-2 rounded input-dark mb-3" placeholder="Пароль (минимум 6 символов)" />
        <div class="flex gap-2">
          <button id="loginBtn" class="px-4 py-2 rounded bg-accent text-white">Войти</button>
          <button id="registerBtn" class="px-4 py-2 rounded btn-soft">Регистрация</button>
        </div>
        <div class="mt-3 small-muted">
          <strong>Тестовый аккаунт:</strong><br>
          Логин: <strong>admin</strong><br>
          Пароль: <strong>admin123</strong>
        </div>
      </div>

      <div class="card p-5 rounded-lg">
        <h3 class="text-lg font-semibold mb-2">О системе</h3>
        <div class="small-muted mb-2">Firebase версия — все данные хранятся в облаке и доступны с любого компьютера в реальном времени.</div>
        <div class="small-muted">Стартовый депозит: <strong>500 ₽</strong>. Дневная просадка: <strong>50 ₽</strong>.</div>
      </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden mt-8">
      <div class="flex items-center justify-between mb-6">
        <nav class="tabs flex gap-3">
          <button class="tab tab-active px-4 py-2 rounded bg-accent text-white" data-tab="tabLeaderboard">Турнирная таблица</button>
          <button class="tab px-4 py-2 rounded btn-soft" data-tab="tabReports">Дневные отчёты</button>
          <button class="tab px-4 py-2 rounded btn-soft" data-tab="tabCharts">Графики</button>
          <button id="adminTabBtn" class="tab px-4 py-2 rounded btn-soft hidden" data-tab="tabAdmin">Админка</button>
        </nav>
        <div class="flex gap-2">
          <button id="openProfileBtn" class="px-3 py-2 rounded btn-soft">Профиль</button>
          <button id="logoutBtn" class="px-3 py-2 rounded btn-soft">Выйти</button>
        </div>
      </div>

      <!-- Leaderboard -->
      <section id="tabLeaderboard" class="tab-content active">
        <div class="grid grid-cols-3 gap-6">
          <div class="card p-4 rounded-lg col-span-2">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-xl font-semibold">Турнирная таблица</h2>
              <div class="small-muted">Клик по строке — график трейдера</div>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full text-left">
                <thead class="table-header">
                  <tr>
                    <th class="p-3 small-muted">Место</th>
                    <th class="p-3 small-muted">Участник</th>
                    <th class="p-3 small-muted">Капитал (₽)</th>
                    <th class="p-3 small-muted">Прирост</th>
                  </tr>
                </thead>
                <tbody id="leaderboardBody"></tbody>
              </table>
            </div>

            <div class="mt-6">
              <h3 class="text-md font-medium mb-2">График выбранного трейдера</h3>
              <canvas id="miniChart" height="160"></canvas>
            </div>
          </div>

          <aside class="card p-4 rounded-lg">
            <h3 class="font-semibold mb-2">Статистика</h3>
            <div id="quickStats" class="small-muted">—</div>
            <div class="mt-4">
              <h4 class="font-medium mb-1">Ваш профиль</h4>
              <div id="accountHighlight" class="p-3 rounded input-dark small-muted">—</div>
            </div>
          </aside>
        </div>
      </section>

      <!-- Reports -->
      <section id="tabReports" class="tab-content hidden mt-6">
        <div class="card p-4 rounded-lg mb-6">
          <h3 class="text-lg font-semibold mb-2">Добавить отчёт</h3>
          <div id="reportError" class="text-sm text-red-300 mb-2 hidden"></div>

          <div class="grid grid-cols-6 gap-3">
            <input id="repDate" type="date" class="col-span-1 p-2 rounded input-dark" />
            <select id="repTrader" class="col-span-2 p-2 rounded input-dark"></select>
            <input id="repResult" type="number" step="0.01" placeholder="Результат ₽" class="col-span-1 p-2 rounded input-dark" />
            <input id="repDraw" type="number" step="0.01" placeholder="Просадка ₽" class="col-span-1 p-2 rounded input-dark" />
            <input id="repEmotion" type="number" min="1" max="10" placeholder="Эмоции 1–10" class="col-span-1 p-2 rounded input-dark" />
            <input id="repDiscipline" type="number" min="1" max="10" placeholder="Дисциплина 1–10" class="col-span-1 p-2 rounded input-dark" />
            <div class="col-span-6 flex gap-2">
              <button id="addReport" class="px-4 py-2 rounded bg-green-600 text-white">Сохранить</button>
              <button id="resetReport" class="px-4 py-2 rounded btn-soft">Очистить</button>
            </div>
          </div>
        </div>

        <div class="card p-4 rounded-lg">
          <h3 class="text-lg font-semibold mb-3">Список отчётов</h3>
          <div class="mb-3 flex items-center gap-3">
            <label class="small-muted">Фильтр:</label>
            <select id="reportFilter" class="p-2 rounded input-dark"></select>
            <button id="clearFilter" class="px-3 py-1 rounded btn-soft">Сбросить</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="table-header">
                <tr>
                  <th class="p-2 small-muted">Дата</th>
                  <th class="p-2 small-muted">Трейдер</th>
                  <th class="p-2 small-muted">Результат</th>
                  <th class="p-2 small-muted">Просадка</th>
                  <th class="p-2 small-muted">Эмоции</th>
                  <th class="p-2 small-muted">Дисциплина</th>
                  <th class="p-2 small-muted">Действия</th>
                </tr>
              </thead>
              <tbody id="reportsList"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Charts -->
      <section id="tabCharts" class="tab-content hidden mt-6">
        <div class="card p-4 rounded-lg">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">Графики</h3>
            <div class="small-muted">Выберите метрику и трейдеров</div>
          </div>

          <div class="flex gap-3 items-center mb-4">
            <select id="chartSelectType" class="p-2 rounded input-dark">
              <option value="equity">Эквити</option>
              <option value="drawdown">Просадка</option>
              <option value="emotion">Эмоции</option>
              <option value="discipline">Дисциплина</option>
            </select>
            <div id="chartTraderCheckboxes" class="flex gap-2 flex-wrap"></div>
            <button id="updateChartBtn" class="px-3 py-1 rounded btn-soft">Обновить</button>
          </div>

          <div>
            <canvas id="mainChart" height="300"></canvas>
          </div>
        </div>
      </section>

      <!-- Admin -->
      <section id="tabAdmin" class="tab-content hidden mt-6">
        <div class="card p-4 rounded-lg mb-4">
          <h3 class="text-lg font-semibold mb-2">Управление трейдерами</h3>
          <div class="grid grid-cols-6 gap-3 mb-3">
            <input id="adminNewLogin" class="col-span-2 p-2 rounded input-dark" placeholder="Логин" />
            <input id="adminNewPass" type="text" class="col-span-1 p-2 rounded input-dark" placeholder="Пароль" />
            <input id="adminNewName" class="col-span-2 p-2 rounded input-dark" placeholder="ФИО" />
            <input id="adminNewDeposit" type="number" class="col-span-1 p-2 rounded input-dark" placeholder="Депозит" value="500" />
            <input id="adminNewDraw" type="number" class="col-span-1 p-2 rounded input-dark" placeholder="Просадка" value="50" />
            <div class="col-span-4"></div>
            <button id="adminCreateTrader" class="col-span-2 px-4 py-2 rounded bg-accent text-white">Создать трейдера</button>
          </div>
        </div>

        <div class="card p-4 rounded-lg">
          <h3 class="text-lg font-semibold mb-2">Трейдеры</h3>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="table-header">
                <tr>
                  <th class="p-2 small-muted">Цвет</th>
                  <th class="p-2 small-muted">Логин</th>
                  <th class="p-2 small-muted">ФИО</th>
                  <th class="p-2 small-muted">Депозит</th>
                  <th class="p-2 small-muted">Просадка</th>
                  <th class="p-2 small-muted">Действия</th>
                </tr>
              </thead>
              <tbody id="adminTraderList"></tbody>
            </table>
          </div>
        </div>
      </section>

    </div>
  </div>

<script>
// Firebase конфиг
const firebaseConfig = {
  apiKey: "AIzaSyBy81thxJtPxYBKWWXTvc6esV0ZotophU8",
  authDomain: "lite-invest-chelyabinsk.firebaseapp.com",
  projectId: "lite-invest-chelyabinsk",
  storageBucket: "lite-invest-chelyabinsk.firebasestorage.app",
  messagingSenderId: "196281360483",
  appId: "1:196281360483:web:b889c55fb64ac2f12c9856"
};

// Инициализация Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Коллекции
const USERS_COLLECTION = 'users';
const TRADERS_COLLECTION = 'traders';
const REPORTS_COLLECTION = 'reports';

// Глобальные переменные
let users = [];
let traders = [];
let reports = [];
let current = null;
let mainChart = null, miniChart = null;

// Хелперы
const el = id => document.getElementById(id);
function toast(msg) { alert(msg); }
function uid() { return Math.random().toString(36).slice(2,9); }
function randomColorHsl() { const h = Math.floor(Math.random()*360); return `hsl(${h},70%,55%)`; }
function genColorFromUsername(u) { let h=0; for(let i=0;i<u.length;i++) h = u.charCodeAt(i) + ((h<<5)-h); return `hsl(${Math.abs(h)%360},70%,55%)`; }
function showError(id, txt) { const elErr = document.getElementById(id); if(elErr){ elErr.textContent = txt; elErr.classList.remove('hidden'); } }
function hideError(id) { const elErr = document.getElementById(id); if(elErr) elErr.classList.add('hidden'); }

// Загрузка данных
async function loadAll() {
  try {
    // Загружаем пользователей
    const usersSnapshot = await db.collection(USERS_COLLECTION).get();
    users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    // Загружаем трейдеров
    const tradersSnapshot = await db.collection(TRADERS_COLLECTION).get();
    traders = tradersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    // Загружаем отчеты
    const reportsSnapshot = await db.collection(REPORTS_COLLECTION).get();
    reports = reportsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    // Создаем админа если нет пользователей
    if (users.length === 0) {
      await createDefaultAdmin();
      await createDefaultTrader();
    }
    
    recomputeAllSeries();
    
  } catch (error) {
    console.error('Ошибка загрузки:', error);
  }
}

// Создание админа
async function createDefaultAdmin() {
  const adminData = {
    email: 'admin@liteinvest.ru',
    password: 'admin123',
    role: 'admin',
    name: 'Администратор',
    username: 'admin',
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  await db.collection(USERS_COLLECTION).add(adminData);
}

// Создание трейдера
async function createDefaultTrader() {
  const traderData = {
    username: 'demo',
    name: 'Демо Трейдер',
    deposit: 500,
    drawdown: 50,
    color: randomColorHsl(),
    equity: [500],
    dailyDraw: [],
    emotion: [],
    discipline: [],
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  await db.collection(TRADERS_COLLECTION).add(traderData);
}

// Авторизация
el('loginBtn').addEventListener('click', async () => {
  const username = el('loginUsername').value.trim();
  const password = el('loginPassword').value;
  const email = username + '@liteinvest.ru';
  
  if (!username || !password) {
    showError('loginError', 'Заполните все поля');
    return;
  }
  
  try {
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    const user = userCredential.user;
    
    const userSnapshot = await db.collection(USERS_COLLECTION).where('email', '==', email).get();
    if (userSnapshot.empty) {
      showError('loginError', 'Пользователь не найден');
      return;
    }
    
    const userData = userSnapshot.docs[0].data();
    current = { id: userSnapshot.docs[0].id, uid: user.uid, ...userData };
    enterApp();
    
  } catch (error) {
    showError('loginError', 'Ошибка входа: ' + error.message);
  }
});

// Регистрация
el('registerBtn').addEventListener('click', async () => {
  const username = el('loginUsername').value.trim();
  const password = el('loginPassword').value;
  const email = username + '@liteinvest.ru';
  
  if (!username || !password) {
    showError('loginError', 'Заполните все поля');
    return;
  }
  
  if (password.length < 6) {
    showError('loginError', 'Пароль минимум 6 символов');
    return;
  }
  
  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    const user = userCredential.user;
    
    const userData = {
      email: email,
      password: password,
      role: 'trader',
      name: username,
      username: username,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    await db.collection(USERS_COLLECTION).add(userData);
    
    const traderData = {
      username: username,
      name: username,
      deposit: 500,
      drawdown: 50,
      color: genColorFromUsername(username),
      equity: [500],
      dailyDraw: [],
      emotion: [],
      discipline: [],
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    await db.collection(TRADERS_COLLECTION).add(traderData);
    
    toast('Регистрация успешна! Войдите.');
    el('loginUsername').value = '';
    el('loginPassword').value = '';
    
  } catch (error) {
    showError('loginError', 'Ошибка регистрации: ' + error.message);
  }
});

// Вход в приложение
function enterApp() {
  el('entryPanel').classList.add('hidden');
  el('app').classList.remove('hidden');
  el('userBox').innerHTML = `<div class="text-sm small-muted">Вошёл как <strong>${current.name}</strong> (${current.role})</div>`;
  
  if (current.role === 'admin') {
    el('adminTabBtn').classList.remove('hidden');
  } else {
    el('adminTabBtn').classList.add('hidden');
  }
  
  el('repDate').valueAsDate = new Date();
  populateReportTraderSelect();
  renderAll();
}

// Выход
el('logoutBtn').addEventListener('click', () => {
  auth.signOut();
  current = null;
  el('entryPanel').classList.remove('hidden');
  el('app').classList.add('hidden');
  el('userBox').innerHTML = '';
  el('loginUsername').value = '';
  el('loginPassword').value = '';
});

// Пересчет серий
function recomputeAllSeries() {
  traders.forEach(tr => {
    const r = reports.filter(rr => rr.username === tr.username).sort((a, b) => new Date(a.dateISO) - new Date(b.dateISO));
    tr.equity = [];
    tr.dailyDraw = [];
    tr.emotion = [];
    tr.discipline = [];
    let accum = Number(tr.deposit) || 500;
    tr.equity.push(+accum.toFixed(2));
    r.forEach(rep => {
      accum += Number(rep.result || 0);
      tr.equity.push(+accum.toFixed(2));
      tr.dailyDraw.push(+rep.drawdown);
      tr.emotion.push(+rep.emotion);
      tr.discipline.push(+rep.discipline);
    });
  });
}

// Добавление отчета
el('addReport').addEventListener('click', async () => {
  const dateVal = el('repDate').value;
  if (!dateVal) { showError('reportError', 'Выберите дату'); return; }
  
  let username = el('repTrader').value;
  if (current.role === 'trader') username = current.username;
  
  const t = traders.find(tt => tt.username === username);
  if (!t) { showError('reportError', 'Трейдер не найден'); return; }
  
  const res = parseFloat(el('repResult').value);
  const draw = parseFloat(el('repDraw').value);
  const emo = parseInt(el('repEmotion').value);
  const disc = parseInt(el('repDiscipline').value);
  
  if (Number.isNaN(res) || Number.isNaN(draw) || Number.isNaN(emo) || Number.isNaN(disc)) {
    showError('reportError', 'Заполните все поля');
    return;
  }
  
  const dateISO = new Date(dateVal + 'T00:00:00').toISOString();
  const id = uid();
  
  const reportData = {
    id, dateISO, username: t.username, name: t.name, result: res, drawdown: draw, emotion: emo, discipline: disc,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  
  try {
    await db.collection(REPORTS_COLLECTION).add(reportData);
    reports.push(reportData);
    recomputeAllSeries();
    
    el('repResult').value = ''; el('repDraw').value = ''; el('repEmotion').value = ''; el('repDiscipline').value = '';
    hideError('reportError');
    renderReportsList(el('reportFilter').value);
    renderLeaderboard(); renderMainChart(); updateQuickStats(); renderMiniChart(t.username);
    toast('Отчет сохранен!');
    
  } catch (error) {
    toast('Ошибка сохранения');
  }
});

// Удаление отчета
async function deleteReport(reportId) {
  if (!confirm('Удалить отчёт?')) return;
  try {
    const reportDoc = await db.collection(REPORTS_COLLECTION).where('id', '==', reportId).get();
    if (!reportDoc.empty) await reportDoc.docs[0].ref.delete();
    reports = reports.filter(rr => rr.id !== reportId);
    recomputeAllSeries();
    renderReportsList(el('reportFilter').value);
    renderLeaderboard(); renderMainChart(); updateQuickStats();
  } catch (error) {
    toast('Ошибка удаления');
  }
}

// Создание трейдера
el('adminCreateTrader').addEventListener('click', async () => {
  if (!(current && current.role === 'admin')) { toast('Только админ'); return; }
  
  const login = el('adminNewLogin').value.trim();
  const pass = el('adminNewPass').value;
  const name = el('adminNewName').value.trim() || login;
  const deposit = Number(el('adminNewDeposit').value) || 500;
  const draw = Number(el('adminNewDraw').value) || 50;
  
  if (!login || !pass) { toast('Заполните логин и пароль'); return; }
  if (users.find(u => u.username === login)) { toast('Логин занят'); return; }
  
  try {
    const email = login + '@liteinvest.ru';
    await auth.createUserWithEmailAndPassword(email, pass);
    
    const userData = { email, password: pass, role: 'trader', name, username: login, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
    await db.collection(USERS_COLLECTION).add(userData);
    
    const traderData = { username: login, name, deposit, drawdown: draw, color: randomColorHsl(), equity: [deposit], dailyDraw: [], emotion: [], discipline: [], createdAt: firebase.firestore.FieldValue.serverTimestamp() };
    await db.collection(TRADERS_COLLECTION).add(traderData);
    
    await loadAll();
    renderAll();
    el('adminNewLogin').value = ''; el('adminNewPass').value = ''; el('adminNewName').value = '';
    toast('Трейдер создан!');
    
  } catch (error) {
    toast('Ошибка: ' + error.message);
  }
});

// Рендер интерфейса
function renderAll() {
  renderAdminList();
  renderLeaderboard();
  renderReportsList();
  updateReportFilter();
  renderTraderCheckboxes();
  renderMainChart();
  renderMiniChart(traders[0] ? traders[0].username : null);
  updateQuickStats();
  populateReportTraderSelect();
}

function renderLeaderboard() {
  const tbody = el('leaderboardBody');
  const stats = traders.map(tr => {
    const capital = tr.equity && tr.equity.length ? tr.equity[tr.equity.length - 1] : tr.deposit;
    const growth = (((capital - tr.deposit) / tr.deposit) * 100).toFixed(2);
    return { username: tr.username, name: tr.name, color: tr.color, capital, growth };
  }).sort((a, b) => b.capital - a.capital);

  tbody.innerHTML = '';
  stats.forEach((s, idx) => {
    const isCurrent = current && current.username === s.username;
    const row = document.createElement('tr');
    row.className = `border-b border-white/5 ${isCurrent ? 'highlight-row' : ''}`;
    row.innerHTML = `
      <td class="p-3 align-middle">${idx + 1}</td>
      <td class="p-3 align-middle flex items-center gap-3">
        <div class="color-dot" style="background:${s.color}"></div>
        <div>
          <div class="font-medium">${s.name}</div>
          <div class="small-muted text-xs">${s.username}</div>
        </div>
      </td>
      <td class="p-3 font-semibold align-middle">${Number(s.capital).toFixed(2)} ₽</td>
      <td class="p-3 align-middle ${Number(s.growth) >= 0 ? 'positive' : 'negative'}">${s.growth}%</td>
    `;
    row.addEventListener('click', () => renderMiniChart(s.username));
    tbody.appendChild(row);
  });
}

function renderReportsList(filterUsername) {
  const tbody = el('reportsList');
  const sorted = reports.slice().sort((a, b) => new Date(b.dateISO) - new Date(a.dateISO));
  tbody.innerHTML = '';
  
  sorted.filter(r => !filterUsername || filterUsername === 'all' ? true : r.username === filterUsername).forEach(r => {
    const tr = document.createElement('tr');
    tr.className = (r.result >= 0) ? 'positive border-b border-white/5' : 'negative border-b border-white/5';
    tr.innerHTML = `
      <td class="p-2">${new Date(r.dateISO).toLocaleDateString()}</td>
      <td class="p-2">${r.name}</td>
      <td class="p-2">${(r.result >= 0 ? '+' : '') + Number(r.result).toFixed(2)} ₽</td>
      <td class="p-2">${Number(r.drawdown).toFixed(2)} ₽</td>
      <td class="p-2">${r.emotion}</td>
      <td class="p-2">${r.discipline}</td>
      <td class="p-2">
        ${(current && current.role === 'admin') || (current && current.role === 'trader' && current.username === r.username) 
          ? `<button data-id="${r.id}" class="delete-report px-2 py-1 rounded btn-soft">Удалить</button>` 
          : ''}
      </td>
    `;
    
    const deleteBtn = tr.querySelector('.delete-report');
    if (deleteBtn) {
      deleteBtn.addEventListener('click', (e) => {
        deleteReport(e.target.dataset.id);
      });
    }
    
    tbody.appendChild(tr);
  });
}

function renderAdminList() {
  const tbody = el('adminTraderList');
  tbody.innerHTML = '';
  traders.forEach(t => {
    const trEl = document.createElement('tr');
    trEl.innerHTML = `
      <td class="p-2"><span class="color-dot" style="background:${t.color}"></span></td>
      <td class="p-2">${t.username}</td>
      <td class="p-2">${t.name}</td>
      <td class="p-2">${t.deposit}</td>
      <td class="p-2">${t.drawdown}</td>
      <td class="p-2"><button class="px-2 py-1 rounded btn-soft" data-user="${t.username}">Удалить</button></td>
    `;
    tbody.appendChild(trEl);
  });

  tbody.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const username = e.target.dataset.user;
      if (!confirm('Удалить трейдера?')) return;
      try {
        const traderDoc = await db.collection(TRADERS_COLLECTION).where('username', '==', username).get();
        if (!traderDoc.empty) await traderDoc.docs[0].ref.delete();
        
        const userDoc = await db.collection(USERS_COLLECTION).where('username', '==', username).get();
        if (!userDoc.empty) await userDoc.docs[0].ref.delete();
        
        const reportsDocs = await db.collection(REPORTS_COLLECTION).where('username', '==', username).get();
        reportsDocs.forEach(async doc => await doc.ref.delete());
        
        await loadAll();
        renderAll();
        toast('Трейдер удален!');
      } catch (error) {
        toast('Ошибка удаления');
      }
    });
  });
}

function updateQuickStats() {
  const total = traders.length;
  const totalReports = reports.length;
  const sums = traders.map(t => ({ name: t.name, sum: reports.filter(r => r.username === t.username).reduce((a, b) => a + (b.result || 0), 0) })).sort((a, b) => b.sum - a.sum);
  const top = sums[0] || { name: '—', sum: 0 };
  
  el('quickStats').innerHTML = `
    <div class="mb-2 small-muted">Участников: <strong>${total}</strong></div>
    <div class="small-muted">Отчётов: <strong>${totalReports}</strong></div>
    <div class="small-muted">Лидер: <strong>${top.name}</strong> (${top.sum.toFixed(2)} ₽)</div>
  `;
  
  if (current) {
    const userTrader = traders.find(t => t.username === current.username);
    if (userTrader) {
      const capital = userTrader.equity && userTrader.equity.length ? userTrader.equity[userTrader.equity.length - 1] : userTrader.deposit;
      el('accountHighlight').innerHTML = `
        <strong>${current.name}</strong><br>
        Капитал: <strong>${Number(capital).toFixed(2)} ₽</strong><br>
        Отчётов: <strong>${reports.filter(r => r.username === current.username).length}</strong>
      `;
    }
  }
}

function populateReportTraderSelect() {
  const sel = el('repTrader'); 
  sel.innerHTML = '';
  traders.forEach(t => { 
    const opt = document.createElement('option'); 
    opt.value = t.username; 
    opt.textContent = `${t.name} (${t.username})`; 
    sel.appendChild(opt); 
  });
  if (current && current.role === 'trader') { 
    sel.value = current.username; 
    sel.disabled = true; 
  } else { 
    sel.disabled = false; 
  }
}

function updateReportFilter() { 
  const sel = el('reportFilter'); 
  const prev = sel.value || 'all'; 
  sel.innerHTML = '<option value="all">Все</option>'; 
  traders.forEach(t => { 
    const o = document.createElement('option'); 
    o.value = t.username; 
    o.textContent = t.name + ' (' + t.username + ')'; 
    sel.appendChild(o); 
  }); 
  sel.value = prev || 'all'; 
}

function renderTraderCheckboxes() {
  const container = el('chartTraderCheckboxes'); 
  container.innerHTML = '';
  traders.forEach(t => {
    const label = document.createElement('label');
    label.className = 'inline-flex items-center gap-2 p-2 rounded cursor-pointer';
    label.innerHTML = `<input type="checkbox" checked class="chart-trader-checkbox" data-username="${t.username}" /> <span style="display:inline-flex;align-items:center"><span class="color-dot" style="background:${t.color};margin-right:8px"></span><span style="font-weight:600">${t.name}</span></span>`;
    container.appendChild(label);
  });
}

function getAllDatesSorted() {
  const set = new Set();
  reports.forEach(r => set.add(new Date(r.dateISO).toISOString().slice(0, 10)));
  const arr = Array.from(set).sort((a, b) => new Date(a) - new Date(b));
  return arr;
}

function buildSeriesForMetric(metric, allDates, username) {
  const tr = traders.find(t => t.username === username);
  if (!tr) return allDates.map(_ => null);
  
  if (metric === 'equity') {
    const sumsByDate = {};
    reports.filter(r => r.username === username).forEach(r => {
      const d = new Date(r.dateISO).toISOString().slice(0, 10);
      sumsByDate[d] = (sumsByDate[d] || 0) + Number(r.result || 0);
    });
    
    const out = [];
    let running = tr.deposit || 500;
    out.push(+running.toFixed(2));
    
    for (let i = 0; i < allDates.length; i++) {
      const d = allDates[i];
      const s = sumsByDate[d] || 0;
      running += s;
      out.push(+running.toFixed(2));
    }
    return out;
    
  } else if (metric === 'drawdown') {
    const ddByDate = {};
    reports.filter(r => r.username === username).forEach(r => {
      const d = new Date(r.dateISO).toISOString().slice(0, 10);
      ddByDate[d] = Math.max(ddByDate[d] || 0, Number(r.drawdown || 0));
    });
    
    const out = [0];
    for (let i = 0; i < allDates.length; i++) {
      const d = allDates[i];
      out.push(ddByDate[d] || 0);
    }
    return out;
    
  } else if (metric === 'emotion') {
    const emByDate = {};
    const countByDate = {};
    reports.filter(r => r.username === username).forEach(r => {
      const d = new Date(r.dateISO).toISOString().slice(0, 10);
      emByDate[d] = (emByDate[d] || 0) + Number(r.emotion || 0);
      countByDate[d] = (countByDate[d] || 0) + 1;
    });
    
    const out = [null];
    for (let i = 0; i < allDates.length; i++) {
      const d = allDates[i];
      out.push(countByDate[d] ? +(emByDate[d] / countByDate[d]).toFixed(2) : null);
    }
    return out;
    
  } else if (metric === 'discipline') {
    const diByDate = {};
    const countByDate = {};
    reports.filter(r => r.username === username).forEach(r => {
      const d = new Date(r.dateISO).toISOString().slice(0, 10);
      diByDate[d] = (diByDate[d] || 0) + Number(r.discipline || 0);
      countByDate[d] = (countByDate[d] || 0) + 1;
    });
    
    const out = [null];
    for (let i = 0; i < allDates.length; i++) {
      const d = allDates[i];
      out.push(countByDate[d] ? +(diByDate[d] / countByDate[d]).toFixed(2) : null);
    }
    return out;
  }
  return [];
}

function renderMainChart() {
  const ctx = el('mainChart').getContext('2d');
  if (mainChart) mainChart.destroy();
  
  const metric = el('chartSelectType').value;
  const checked = Array.from(document.querySelectorAll('.chart-trader-checkbox:checked')).map(i => i.dataset.username);
  const allDates = getAllDatesSorted();
  const labels = ['Старт', ...allDates.map(d => (new Date(d + 'T00:00:00')).toLocaleDateString())];
  
  const datasets = checked.map(username => {
    const tr = traders.find(t => t.username === username);
    if (!tr) return null;
    
    const series = buildSeriesForMetric(metric, allDates, username);
    const col = tr.color || randomColorHsl();
    const bg = col.startsWith('#') ? col + '22' : col.replace('hsl', 'hsla').replace(')', ',0.12)');
    
    return {
      label: tr.name,
      data: series,
      borderColor: col,
      backgroundColor: bg,
      tension: 0.25,
      borderWidth: 2,
      pointRadius: 3,
      fill: metric === 'equity'
    };
  }).filter(Boolean);

  mainChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: '#e6eef8' } },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        x: { ticks: { color: '#9fb0c8' } },
        y: { ticks: { color: '#9fb0c8' } }
      }
    }
  });
}

function renderMiniChart(username) {
  const tr = traders.find(t => t.username === username) || traders[0];
  if (!tr) { if (miniChart) miniChart.destroy(); return; }
  
  const ctx = el('miniChart').getContext('2d');
  if (miniChart) miniChart.destroy();
  
  const allDates = getAllDatesSorted();
  const labels = ['Старт', ...allDates.map(d => (new Date(d + 'T00:00:00')).toLocaleDateString())];
  const data = buildSeriesForMetric('equity', allDates, tr.username);
  const col = tr.color || randomColorHsl();
  const bg = col.startsWith('#') ? col + '22' : col.replace('hsl', 'hsla').replace(')', ',0.12)');
  
  miniChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: tr.name,
        data,
        borderColor: col,
        backgroundColor: bg,
        fill: true,
        tension: 0.25,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#9fb0c8' } },
        y: { ticks: { color: '#9fb0c8' } }
      }
    }
  });
}

// Обработчики
el('reportFilter').addEventListener('change', () => renderReportsList(el('reportFilter').value));
el('clearFilter').addEventListener('click', () => { el('reportFilter').value = 'all'; renderReportsList(); });
el('resetReport').addEventListener('click', () => {
  el('repResult').value = '';
  el('repDraw').value = '';
  el('repEmotion').value = '';
  el('repDiscipline').value = '';
});

document.querySelectorAll('.tab').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(b => b.classList.remove('bg-accent', 'text-white'));
    btn.classList.add('bg-accent', 'text-white');
    document.querySelectorAll('.tab-content').forEach(sec => sec.classList.add('hidden'));
    const id = btn.dataset.tab;
    document.getElementById(id).classList.remove('hidden');
    if (id === 'tabCharts') renderMainChart();
  });
});

el('chartSelectType').addEventListener('change', renderMainChart);
el('updateChartBtn').addEventListener('click', renderMainChart);

document.addEventListener('change', (e) => {
  if (e.target && e.target.classList && e.target.classList.contains('chart-trader-checkbox')) {
    renderMainChart();
  }
});

el('openProfileBtn').addEventListener('click', () => {
  if (!current) return;
  if (current.role === 'admin') {
    const newName = prompt('Имя (админ)', current.name) || current.name;
    toast('Функция в разработке');
  } else {
    toast('Функция в разработке');
  }
});

// Автоматический вход при загрузке
auth.onAuthStateChanged(async (user) => {
  if (user) {
    const userSnapshot = await db.collection(USERS_COLLECTION).where('email', '==', user.email).get();
    if (!userSnapshot.empty) {
      const userData = userSnapshot.docs[0].data();
      current = { id: userSnapshot.docs[0].id, uid: user.uid, ...userData };
      enterApp();
    }
  }
});

// Слушаем изменения в реальном времени
db.collection(REPORTS_COLLECTION).onSnapshot(() => {
  if (current) {
    loadAll().then(() => {
      if (current) renderAll();
    });
  }
});

// Инициализация
loadAll();
</script>
</body>
</html>
